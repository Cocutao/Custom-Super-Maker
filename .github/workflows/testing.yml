name: Android Super Repack + OEM Port 

on:
  workflow_dispatch:
    inputs:
      # --- Device Source (Base Firmware) ---
      device_preset:
        description: 'Base: Select Device Firmware'
        required: true
        default: 'none'
        type: choice
        options:
        - 'none (Use Custom URL below)'
        - 'Samsung A04s (64GB)'
        - 'Samsung A15 (128/256GB)'
      stock_firmware_url:
        description: 'Base: URL (If preset is none)'
        required: false
        type: string

      # --- Custom ROM Source (System Image) ---
      enable_oem_port:
        description: 'Mode: Port an OEM ROM? (True = Porting, False = GSI/Custom ROM)'
        required: true
        type: boolean
        default: false
      
      # If Mode = Porting
      port_firmware_url:
        description: 'Port Source: Firmware URL (e.g. HyperOS, OxygenOS zip)'
        required: false
        type: string
      rom_type:
        description: 'Port Source: ROM Type'
        required: false
        type: choice
        options:
          - OneUI
          - Pixel
          - MIUIGeneric
          - HyperOS
          - OxygenOS
          - Flyme
          - Moto

      # If Mode = GSI/Custom ROM
      custom_system_url:
        description: 'GSI Source: System Image URL (Lineage, PixelExp, etc.)'
        required: false
        type: string

      # --- Options ---
      upload_to_release:
        description: 'Upload Result to Release?'
        required: true
        type: boolean
        default: false
      silent_mode:
        description: 'Silent Mode (Legacy flag, logs minimized)'
        required: false
        type: boolean
        default: true

jobs:
  repack-super:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    # --------------------------------------------------------------------------
    # 1. Environment Setup
    # --------------------------------------------------------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Optimize Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true

    - name: Install System Dependencies
      run: |
        echo "==> Installing Tools..."
        sudo apt-get update -qq
        # Android & Filesystem Tools
        sudo apt-get install -y -qq android-sdk-libsparse-utils tar xz-utils liblz4-tool unzip p7zip-full file wget curl megatools f2fs-tools erofs-utils cpio rsync
        # Porting Support Tools
        sudo apt-get install -y -qq unace unrar zip p7zip-rar sharutils rar uudeview mpack arj cabextract rename liblzma-dev brotli lz4 protobuf-compiler git gawk python3-pip
        
        # Python Libs
        pip install -q gdown backports.lzma protobuf twrpdtgen extract-dtb pycryptodome

    - name: Prepare Workspace & Script
      run: |
        mkdir -p work
        
        # Ensure the repack script is executable
        if [ -f "./repacksuper_lite.sh" ]; then
          chmod +x ./repacksuper_lite.sh
        else
          echo "::error::repacksuper_lite.sh not found in repository root."
          exit 1
        fi

    # --------------------------------------------------------------------------
    # 2. Base Firmware Acquisition (Stock Super)
    # --------------------------------------------------------------------------
    - name: Download Base Firmware
      run: |
        cd work
        PRESET="${{ github.event.inputs.device_preset }}"
        URL="${{ github.event.inputs.stock_firmware_url }}"
        
        echo "==> Downloading Base Firmware..."
        if [[ "$PRESET" == "Samsung A04s (64GB)" ]]; then
          gdown --quiet --output stock_firmware.zip '1C9GtYTn1EZ4sQN7qfJeWN6gxDj_WbgY-'
        elif [[ "$PRESET" == "Samsung A15 (128/256GB)" ]]; then
          gdown --quiet --output stock_firmware.zip '12FoeBkPDHddj4lzd-T6pjHRQ8Ey3c2U8'
        elif [ -n "$URL" ]; then
           if [[ $URL == *"mega.nz"* ]]; then megadl -o stock_firmware.zip "$URL"; else wget -q --content-disposition -O stock_firmware.zip "$URL"; fi
        else
           echo "::error::No device preset or URL selected." && exit 1
        fi
        
        if [ ! -s "stock_firmware.zip" ]; then echo "::error::Download failed or empty." && exit 1; fi
        
        echo "==> Extracting Super Partition..."
        # Extract AP file
        AP_FILE=$(unzip -l stock_firmware.zip | grep -ioE "AP_.*\.tar\.md5" | head -n1)
        unzip -o -j stock_firmware.zip "$AP_FILE"
        rm stock_firmware.zip
        
        # Extract and Decompress Super
        tar -xf "$AP_FILE" --wildcards '*super.img.lz4'
        lz4 -d super.img.lz4 stock_super_sparse.img
        rm super.img.lz4 "$AP_FILE"

    # --------------------------------------------------------------------------
    # 3. Custom System Acquisition (Port or Download)
    # --------------------------------------------------------------------------
    - name: Generate Custom System (Porting Mode)
      if: github.event.inputs.enable_oem_port == 'true'
      run: |
        echo "==> Porting Mode Enabled."
        git clone https://github.com/minhmc2007/Link2GSI
        cd Link2GSI
        
        # Fix Submodules
        rm -rf Tools/Firmware_extractor
        git clone https://github.com/erfanoabdi/Firmware_extractor.git Tools/Firmware_extractor
        
        # Download Source
        wget -q --content-disposition -O firmware.zip "${{ github.event.inputs.port_firmware_url }}"
        
        # Execute Port
        sudo bash LinkToGSI.sh "$(pwd)/firmware.zip" "${{ github.event.inputs.rom_type }}"
        
        # Locate Output
        IMG=$(find Output -name "*.img" | head -n1)
        if [ -z "$IMG" ]; then echo "::error::Porting failed to produce an image." && exit 1; fi
        
        # Move to work dir
        sudo mv "$IMG" ../work/custom_system.img
        sudo chown $(whoami) ../work/custom_system.img
        sudo rm -rf ../Link2GSI

    - name: Download Custom System (GSI Mode)
      if: github.event.inputs.enable_oem_port == 'false'
      run: |
        echo "==> GSI/ROM Download Mode."
        URL="${{ github.event.inputs.custom_system_url }}"
        if [ -z "$URL" ]; then echo "::error::Custom System URL is required." && exit 1; fi
        
        cd work
        wget -q -O rom_package "$URL"
        
        # Detect and Extract
        TYPE=$(file -b rom_package)
        echo "File Type: $TYPE"
        
        if [[ "$TYPE" == *"XZ compressed"* ]]; then mv rom_package s.xz; unxz s.xz; mv s custom_system.img
        elif [[ "$TYPE" == *"gzip compressed"* ]]; then mv rom_package s.gz; gzip -d s.gz; mv s custom_system.img
        elif [[ "$TYPE" == *"Zip archive"* ]]; then unzip -o rom_package
        elif [[ "$TYPE" == *"7-zip"* ]]; then 7z x rom_package
        else mv rom_package custom_system.img; fi
        
        # Ensure we have the .img
        if [ ! -f "custom_system.img" ]; then
           FIND=$(find . -maxdepth 2 -name "*.img" ! -name "stock_super_sparse.img" | head -n1)
           if [ -n "$FIND" ]; then mv "$FIND" custom_system.img; else echo "::error::Extraction failed." && exit 1; fi
        fi

    # --------------------------------------------------------------------------
    # 4. Super Partition Repack (The Core Logic)
    # --------------------------------------------------------------------------
    - name: Execute Repack Script
      run: |
        echo "==> Starting Repack Process..."
        
        # 1. Verify Inputs
        if [ ! -f "work/stock_super_sparse.img" ]; then echo "::error::Stock Super Image missing."; exit 1; fi
        if [ ! -f "work/custom_system.img" ]; then echo "::error::Custom System Image missing."; exit 1; fi
        
        # 2. Execute with Sudo (Required for EROFS/Mounting)
        # Usage: sudo ./script <Source> <System> <Output>
        sudo ./repacksuper_lite.sh \
          work/stock_super_sparse.img \
          work/custom_system.img \
          work/repacked_super.img
        
        # 3. Verify Output
        if [ ! -f "work/repacked_super.img" ]; then
           echo "::error::Repack script finished but output file is missing."
           exit 1
        fi

    # --------------------------------------------------------------------------
    # 5. Final Packaging & Upload
    # --------------------------------------------------------------------------
    - name: Compress and Upload
      id: package
      run: |
        cd work
        mv repacked_super.img super.img
        TAR_NAME="super_repack_${{ github.run_id }}.tar"
        
        echo "==> Creating Tarball: $TAR_NAME"
        tar -cvf "$TAR_NAME" super.img
        
        echo "tar_path=work/$TAR_NAME" >> $GITHUB_OUTPUT

    - name: Upload to Release
      if: github.event.inputs.upload_to_release == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: build-${{ github.run_id }}
        files: ${{ steps.package.outputs.tar_path }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
